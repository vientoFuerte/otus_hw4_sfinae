name: 'C++ CI with Documentation'

on:
  push:
    branches:
      - main
      - feature/github_actions

jobs:
  build:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      
      # Устанавливаем и компилируем GTest вместо Boost
      - run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtest-dev \
            libgmock-dev \
            cmake \
            build-essential \
            doxygen \
            graphviz
          cd /usr/src/googletest
          sudo cmake CMakeLists.txt
          sudo make
          sudo cp lib/libgtest*.a /usr/lib
          sudo cp lib/libgmock*.a /usr/lib
      
      # Отключаем Boost.Test, используем GTest
      - run: cmake . -DWITH_BOOST_TEST=OFF
      - run: cmake . -DWITH_TESTS=ON
      - run: cmake --build .
      
      # Проверяем и запускаем тесты если они есть
      - run: |
          if [ -f "./print_ip_tests" ]; then
            ./print_ip_tests
          elif [ -f "./test.cpp" ]; then
            echo "Test executable not found, but test.cpp exists"
          else
            echo "No tests to run"
          fi
      
      - run: cmake --build . --target package

      # Генерируем документацию Doxygen
      - name: Generate Doxygen documentation
        run: |
          # Проверяем наличие Doxyfile или создаем его
          if [ ! -f "Doxyfile" ]; then
            echo "Doxyfile not found, generating default configuration..."
            doxygen -g Doxyfile
            # Обновляем основные настройки
            sed -i 's/^PROJECT_NAME.*/PROJECT_NAME = "Print IP"/' Doxyfile
            sed -i 's/^OUTPUT_DIRECTORY.*/OUTPUT_DIRECTORY = docs/' Doxyfile
            sed -i 's/^GENERATE_HTML.*/GENERATE_HTML = YES/' Doxyfile
            sed -i 's/^GENERATE_LATEX.*/GENERATE_LATEX = NO/' Doxyfile
            sed -i 's/^RECURSIVE.*/RECURSIVE = YES/' Doxyfile
            sed -i 's/^EXTRACT_ALL.*/EXTRACT_ALL = YES/' Doxyfile
            sed -i 's/^EXTRACT_PRIVATE.*/EXTRACT_PRIVATE = YES/' Doxyfile
            sed -i 's/^EXTRACT_STATIC.*/EXTRACT_STATIC = YES/' Doxyfile
          fi
                    
          # Генерируем документацию
          mkdir -p docs
          doxygen Doxyfile
          
          # Проверяем, сгенерировалась ли HTML документация
          if [ -d "docs/html" ]; then
            echo "Documentation generated successfully"
            ls -la docs/html/
          else
            echo "Warning: HTML documentation was not generated"
            ls -la docs/
          fi
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.run_number }}
          release_name: Release ${{ github.run_number }}
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./print_ip.deb
          asset_name: print_ip.deb
          asset_content_type: application/vnd.debian.binary-package

      # Публикуем документацию на GitHub Pages
      - name: Deploy documentation to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/html
          publish_branch: gh-pages
          force_orphan: true
          jekyll: false  # Явно отключаем обработку Jekyll
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy Doxygen documentation'
